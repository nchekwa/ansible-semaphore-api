name: OpenAPI Generator


on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
    paths:
      - 'variable.env'
      - '.github/workflows/openapi-generator.yml'

permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  ### Generate OpenAPI ######################################################
  generate_openapi:
    environment: staging
    runs-on: ubuntu-latest
    env:
      GIT_PUSH: "false"
      PYPI_NAME: ${{ vars.PYPI_NAME }}
      PYPI_VERSION: ${{ vars.PYPI_VERSION }}
      SEMAPHORE_VERSION: ${{ vars.SEMAPHORE_VERSION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up OpenAPI Generator
        run: |
          wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.1.0/openapi-generator-cli-7.1.0.jar -O /tmp/openapi-generator-cli.jar

      - name: OpenAPI Download Ansible Semaphore API-Docs
        run: |
          OWNER=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)        &&  echo "OWNER=$OWNER" >> "$GITHUB_ENV"
          REPOSITORY=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2)   &&  echo "REPOSITORY=$REPOSITORY" >> "$GITHUB_ENV"
          cd /tmp/
          curl "https://converter.swagger.io/api/convert?url=https://raw.githubusercontent.com/ansible-semaphore/semaphore/v$SEMAPHORE_VERSION/api-docs.yml" -H "Accept: application/yaml" -o api-docs.yml
          
      - name: OpenAPI Extract Python Template
        run: |
          cd /tmp/ &&
          java -jar /tmp/openapi-generator-cli.jar author template \
            -g python \
            -o templates/python

      - name: Apply Patch on Python Template
        run: |
          patch -p1 /tmp/templates/python/api_client.mustache < $GITHUB_WORKSPACE/patch/api_client.mustache.patch
          
      - name: OpenAPI Generate
        run: |
          cd /tmp/ &&
          java -jar /tmp/openapi-generator-cli.jar generate \
            -i api-docs.yml \
            -g python \
            -t templates/python \
            -o openapi \
            --package-name $PYPI_NAME \
            --git-repo-id $REPOSITORY \
            --git-user-id $OWNER
        
      - name: Update repository
        run: |
          cd $GITHUB_WORKSPACE
          rm -fR $GITHUB_WORKSPACE/$PYPI_NAME && cp -r /tmp/openapi/$PYPI_NAME $GITHUB_WORKSPACE/
          rm -fR $GITHUB_WORKSPACE/docs && cp -r /tmp/openapi/docs $GITHUB_WORKSPACE/
          rm -fR $GITHUB_WORKSPACE/test && cp -r /tmp/openapi/test $GITHUB_WORKSPACE/
          cp /tmp/openapi/README.md $GITHUB_WORKSPACE/README_OPENAPI.md
          ls -la $GITHUB_WORKSPACE/

      - name: Check for changes
        id: check_changes
        run: |
          cd $GITHUB_WORKSPACE
          echo "GIT_PUSH=false" >> $GITHUB_ENV
          
          if git status --porcelain | grep -q '^??'; then
            echo "Git Status: Untracked files found. Adding them to the staging area."
            echo "GIT_PUSH=true" >> $GITHUB_ENV
          elif git status --porcelain | grep -q '^\s*D'; then
            echo "Git Status: Deleted files found. Perform actions for deleted files."
            echo "GIT_PUSH=true" >> $GITHUB_ENV
          else
            echo "Git Status: No untracked or deleted files."
          fi

          if ! git diff --quiet; then
              echo "Git Files Diff: Changes detected in some files, proceeding with commit."
              echo "GIT_PUSH=true" >> $GITHUB_ENV
          else
              echo "Git Files Diff: No differences found between the working directory and the staging area."      
          fi

      - name: Commit changes
        if: env.GIT_PUSH == 'true'
        run: |
          git config --local user.name actions-user
          git config --local user.email "github@nchekwa.com"
          git status
          git add --all
          git commit -am "GitHub Actions OpenAPI Update $(date +"%Y-%m-%d %H:%M:%S")"s
          git push -f


    outputs:
      GIT_PUSH: ${{ env.GIT_PUSH }}


  call-workflow-test:
    uses: ./.github/workflows/python-test.yml
    secrets: inherit